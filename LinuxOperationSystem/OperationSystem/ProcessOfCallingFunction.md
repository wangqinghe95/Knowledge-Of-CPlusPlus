# 函数调用的过程
1. 参数如栈：将参数从右向左一次压入系统栈
2. 返回地址入栈：将当前代码区调用指令的下一条指令压入栈中，供函数返回时继续执行
3. 代码区跳转：处理器从当前代码区跳转到被调用函数的入口处
4. 局部变量和临时变量入栈：被调用函数内部定义的局部变量和临时变量在栈中分配
5. 函数出栈：当函数执行完毕后，处理器从当前代码区跳转到调用函数的位置，同时将被调用函数的返回值压入栈中

## C++ 如何将临时变量返回给调用函数的
1. 创建临时对象：会函数内部创建一个临时对象，并将该临时对象存存储在 eax 寄存器中
2. 返回临时对象：将临时对象作为返回值返回给调用函数
3. 销毁临时对象：函数返回后，系统自动销毁临时对象
+ 临时对象会被存放在寄存器 eax 中，如果对象是类的话，会返回一个指向该对象的存储地址的指针


## 函数调用详解
### 寄存器
1. CPU 一般有 16，其中以下几个寄存器有特别的用处
    + %rsp: 保持栈指针，通常通过修改该寄存器中的值实现入栈出栈
    + %rip: 保存程序代码中下一条指令的内存地址。
        - 处理器在每条指令执行完毕之后自动增加 %rip 的值
        - 控制流指令，如跳转指令，会修改 %rip 的值以实现跳转的功能
    + %rbp: 保存帧指针，用于标识当前栈帧的起始位置
    + %rax: 保持返回值，低 32 位寄存器名为 %eax
    + %rdi/%rsi/%rdx/%rcx/%r8/%r9: 保存前六个函数参数
    + others: 保存任何值

### 栈
+ 栈是先进后出的一种数据结构，主要用来实现函数调用。程序执行从 main 函数开始
    + 栈在虚拟内存中从高地址向低地址增长
    + 栈主要是通过一个栈指针来控制函数调用，也就是增加或者减小保存在 %rsp 寄存器中的值，来实现进栈和栈的操作
        + 进栈：将栈指针向下移动指定字节大小，即栈顶指针值减去字节值数，然后给这块指定大小的内存赋值。
        - 出栈：将栈指针向上移动指定大小字节位置即可，即栈顶指针加上要出栈数据所占用的字节大小即可。

### 函数调用的入栈过程
1. 调用指令
    + 在函数调用点，会发出一个调用指令，将控制权转移到被调用函数的入口
2. 将调用函数的函数参数保存到寄存器中
    + 按照调用函数形参声明顺序，从右向左保存，如果参数数量超过 6 个，则按照形参声明的顺序，从后往前一次压栈
3. 将函数返回地址压栈
    + 将被调用函数的下一行指令地址入栈
4. 某些寄存器值入栈
    + 函数调用时会保持一些寄存器值，以便在函数调用结束时能够恢复原始的寄存器状态
5. 帧指针和局部变量压栈
    + 为了支持函数内部的局部变量和堆栈上的动态分配，通常会在栈上维护一个帧指针
    + 帧指针指向当前函数的帧栈底部，也就是该函数调用地址的最高处。
    + 保存帧指针的寄存器是 %rbp
6. 执行调用函数
    + 将被调用函数地址传递给 PC 寄存器， %rip
    + 开始执行函数中的代码

### 函数调用的出栈过程
1. 恢复寄存器值
2. 释放局部变量和帧指针
    - 将帧指针恢复到父函数的栈指针，即返回上一层函数
3. 弹出参数和返回地址
        - 参数和返回地址从栈中弹出，将控制权返回到调用函数的正确位置

## 从汇编角度看函数调用过程
// TODO